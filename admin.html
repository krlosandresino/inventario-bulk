<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üõ†Ô∏è Admin - Bulk</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #f8fafc; padding: 20px; margin: 0; }
        #loginOverlay { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #1e293b; padding: 40px; border-radius: 15px; border: 1px solid #334155; text-align: center; width: 320px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; outline: none; }
        .btn-login { width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        #adminContent { display: none; }
        .admin-container { max-width: 1250px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { background: #1e293b; padding: 15px; border-radius: 10px; border-bottom: 4px solid #3b82f6; text-align: center; }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; color: white; margin-left: 5px; }
        .btn-upload { background: #3b82f6; }
        .btn-download { background: #10b981; }
        .btn-reset { background: #ef4444; }
        
        .search-container { margin-bottom: 15px; }
        .search-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 1rem; outline: none; box-sizing: border-box; }

        .table-area { background: #1e293b; border-radius: 12px; overflow: hidden; border: 1px solid #334155; max-height: 60vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; color: #3b82f6; padding: 15px; text-align: left; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #334155; }
        .visto { background: #064e3b !important; }
        .incidencia-text { color: #fcd34d; font-style: italic; font-size: 0.9em; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: #3b82f6; margin-top: 0;">Acceso Admin</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Clave">
        <button class="btn-login" onclick="validarAcceso()">Entrar</button>
    </div>
</div>

<div id="adminContent" class="admin-container">
    <div class="header">
        <h2>üõ†Ô∏è Gesti√≥n Inventario Bulk</h2>
        <div>
            <input type="file" id="fileInput" accept=".xlsx" style="display:none">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">üìÇ Cargar ubicaciones</button>
            <button class="btn btn-download" onclick="descargarExcel()">üì• Descargar Reporte</button>
            <button class="btn btn-reset" onclick="limpiarSistema()">üóëÔ∏è Borrar datos</button>
        </div>
    </div>

    <div class="stats">
        <div class="card"><h3 id="statProgreso">0%</h3><small>PROGRESO</small></div>
        <div class="card"><h3 id="statUbis">0</h3><small>UBICACIONES</small></div>
        <div class="card"><h3 id="statVistos">0</h3><small>VISTOS (c√≥digos)</small></div>
        <div class="card"><h3 id="statPend" style="color:#ef4444">0</h3><small>PENDIENTES</small></div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar por c√≥digo, ubicaci√≥n o incidencia..." onkeyup="filtrarYMostrar()">
    </div>

    <div class="table-area">
        <table>
            <thead>
                <tr><th>UBICACI√ìN</th><th>C√ìDIGO</th><th>CANTIDAD</th><th>ESTADO</th><th>RESPONSABLE</th><th>INCIDENCIAS</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDcHhz-f_oYGaEX2ABtYKqgVEyypSnuz_E",
        authDomain: "inventariobulk.firebaseapp.com",
        projectId: "inventariobulk",
        storageBucket: "inventariobulk.firebasestorage.app",
        messagingSenderId: "962249508789",
        appId: "1:962249508789:web:53c38b692e41c10c8bfbfc",
        databaseURL: "https://inventariobulk-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dataLocal = [];

    document.getElementById('pass').onkeydown = e => { if(e.key === 'Enter') validarAcceso(); };

    function validarAcceso() {
        if(document.getElementById('user').value === "oriflame" && document.getElementById('pass').value === "2026") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
        } else { alert("Credenciales incorrectas"); }
    }

    document.getElementById('fileInput').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            const items = raw.slice(1).filter(r => r[1]).map((r, i) => ({
                datos: [String(r[3]||'S/U').trim(), String(r[1]||'S/C').trim(), r[5]||0],
                visto: false, auditor: "", incidencia: "", rowId: i
            }));

            db.ref('inventario_actual').set({ items }).then(() => {
                alert("‚úÖ Inventario cargado correctamente");
                document.getElementById('fileInput').value = "";
            });
        };
        reader.readAsArrayBuffer(file);
    };

    db.ref('inventario_actual/items').on('value', snap => {
        dataLocal = snap.val() || [];
        filtrarYMostrar();
    });

    function filtrarYMostrar() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        let itemsFiltrados = dataLocal.filter(i => 
            i.datos[1].toLowerCase().includes(term) || 
            i.datos[0].toLowerCase().includes(term) ||
            (i.incidencia && i.incidencia.toLowerCase().includes(term))
        );
        itemsFiltrados.sort((a, b) => (a.visto === b.visto) ? 0 : a.visto ? 1 : -1);
        actualizarUI(itemsFiltrados);
    }

    function actualizarUI(items) {
        const totalItems = dataLocal.length;
        const vistos = dataLocal.filter(i => i.visto).length;
        const todasUbis = [...new Set(dataLocal.map(i => i.datos[0]))];
        const ubisPend = todasUbis.filter(u => dataLocal.filter(i => i.datos[0] === u).some(i => !i.visto)).length;

        document.getElementById('statProgreso').innerText = totalItems ? Math.round((vistos/totalItems)*100) + '%' : '0%';
        document.getElementById('statUbis').innerText = todasUbis.length;
        document.getElementById('statVistos').innerText = vistos;
        document.getElementById('statPend').innerText = ubisPend;

        document.getElementById('tbody').innerHTML = items.map(i => `
            <tr class="${i.visto ? 'visto' : ''}">
                <td><b>${i.datos[0]}</b></td>
                <td>${i.datos[1]}</td>
                <td>${i.datos[2]}</td>
                <td>${i.visto ? '‚úÖ' : '‚è≥'}</td>
                <td>${i.auditor || '-'}</td>
                <td class="incidencia-text">${i.incidencia || '-'}</td>
            </tr>
        `).join('');
    }

    function descargarExcel() {
        if (dataLocal.length === 0) return alert("No hay datos para descargar");
        const rows = dataLocal.map(i => ({
            UBICACI√ìN: i.datos[0],
            C√ìDIGO: i.datos[1],
            CANTIDAD: i.datos[2],
            ESTADO: i.visto ? "COMPLETADO" : "PENDIENTE",
            RESPONSABLE: i.auditor || "",
            INCIDENCIAS: i.incidencia || ""
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, `Reporte_Final_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function limpiarSistema() {
        if(confirm("‚ö†Ô∏è Se borrar√° toda la informaci√≥n.")) {
            db.ref('inventario_actual').remove();
        }
    }

    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && (e.keyCode == 85 || e.keyCode == 83))) {
            return false;
        }
    };
</script>
</body>
</html>